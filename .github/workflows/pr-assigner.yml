name: PR Auto Assigner

on:
  pull_request:
    types: [opened, reopened]

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Auto assign PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const author = context.payload.pull_request.user.login;

            // PR ì‘ì„±ìë¥¼ ê¸°ë³¸ ë‹´ë‹¹ìë¡œ í• ë‹¹
            const assignees = [author];

            // íŒŒì¼ ë³€ê²½ ë‚´ìš©ì— ë”°ë¥¸ ì¶”ê°€ ë‹´ë‹¹ì í• ë‹¹ ë¡œì§
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // ë°±ì—”ë“œ íŒŒì¼ ë³€ê²½ ì‹œ ë°±ì—”ë“œ ë‹´ë‹¹ì ì¶”ê°€
            const backendFiles = files.filter(file => 
              file.filename.startsWith('backend/') || 
              file.filename.includes('api') ||
              file.filename.includes('main.py') ||
              file.filename.includes('requirements.txt')
            );

            // í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë³€ê²½ ì‹œ í”„ë¡ íŠ¸ì—”ë“œ ë‹´ë‹¹ì ì¶”ê°€
            const frontendFiles = files.filter(file => 
              file.filename.startsWith('frontend/') ||
              file.filename.includes('streamlit') ||
              file.filename.includes('app.py')
            );

            // í…ŒìŠ¤íŠ¸ íŒŒì¼ ë³€ê²½ ì‹œ QA ë‹´ë‹¹ì ì¶”ê°€
            const testFiles = files.filter(file => 
              file.filename.startsWith('tests/') ||
              file.filename.includes('test_') ||
              file.filename.includes('.test.')
            );

            // GitHub Actions ë˜ëŠ” ì„¤ì • íŒŒì¼ ë³€ê²½ ì‹œ DevOps ë‹´ë‹¹ì ì¶”ê°€
            const configFiles = files.filter(file => 
              file.filename.startsWith('.github/') ||
              file.filename.includes('docker') ||
              file.filename.includes('requirements') ||
              file.filename.includes('.yml') ||
              file.filename.includes('.yaml')
            );

            let additionalMessage = '';

            if (backendFiles.length > 0) {
              additionalMessage += 'ğŸ”§ ë°±ì—”ë“œ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
            }

            if (frontendFiles.length > 0) {
              additionalMessage += 'ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
            }

            if (testFiles.length > 0) {
              additionalMessage += 'ğŸ§ª í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
            }

            if (configFiles.length > 0) {
              additionalMessage += 'âš™ï¸ ì„¤ì • íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n';
            }

            // PRì— ë‹´ë‹¹ì í• ë‹¹
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              assignees: assignees
            });

            // í• ë‹¹ ì™„ë£Œ ëŒ“ê¸€ ì¶”ê°€
            if (additionalMessage) {
              const comment = `### ğŸ¯ ìë™ í• ë‹¹ ì™„ë£Œ
              
              **ë‹´ë‹¹ì**: ${assignees.map(a => `@${a}`).join(', ')}
              
              **ë³€ê²½ íŒŒì¼ ë¶„ì„**:
              ${additionalMessage}
              
              ---
              *ë‹´ë‹¹ìê°€ ìë™ìœ¼ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.*`;
              
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
