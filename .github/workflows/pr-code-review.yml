name: PR Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto Code Review
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;

            // PR íŒŒì¼ ë³€ê²½ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const reviews = [];

            for (const file of files) {
              const filename = file.filename;
              const patch = file.patch || '';
              
              // Python íŒŒì¼ì— ëŒ€í•œ ì½”ë“œ ë¦¬ë·°
              if (filename.endsWith('.py')) {
                const lines = patch.split('\n');
                let lineNumber = 0;
                
                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i];
                  
                  // ì¶”ê°€ëœ ë¼ì¸ë§Œ ê²€í† 
                  if (line.startsWith('+') && !line.startsWith('+++')) {
                    const code = line.substring(1).trim();
                    lineNumber++;
                    
                    // ì½”ë“œ ë¦¬ë·° ì²´í¬ í•­ëª©ë“¤
                    const suggestions = [];
                    
                    // 1. Import ë¬¸ ì²´í¬
                    if (code.includes('import *')) {
                      suggestions.push('ğŸš¨ `import *` ì‚¬ìš©ì„ í”¼í•˜ê³  í•„ìš”í•œ ëª¨ë“ˆë§Œ ëª…ì‹œì ìœ¼ë¡œ importí•˜ì„¸ìš”.');
                    }
                    
                    // 2. í•˜ë“œì½”ë”©ëœ ê°’ ì²´í¬
                    if (code.includes('localhost') || code.includes('127.0.0.1')) {
                      suggestions.push('ğŸ’¡ í•˜ë“œì½”ë”©ëœ í˜¸ìŠ¤íŠ¸ ì£¼ì†Œ ëŒ€ì‹  í™˜ê²½ë³€ìˆ˜ë‚˜ ì„¤ì • íŒŒì¼ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.');
                    }
                    
                    // 3. ë¹„ë°€ë²ˆí˜¸ë‚˜ í‚¤ í•˜ë“œì½”ë”© ì²´í¬
                    if (code.toLowerCase().includes('password') || code.toLowerCase().includes('secret') || code.toLowerCase().includes('key')) {
                      if (code.includes('=') && !code.includes('os.environ') && !code.includes('getenv')) {
                        suggestions.push('ğŸ” ë¹„ë°€ë²ˆí˜¸ë‚˜ í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.');
                      }
                    }
                    
                    // 4. ê¸´ í•¨ìˆ˜ë‚˜ í´ë˜ìŠ¤ ì²´í¬
                    if (code.includes('def ') || code.includes('class ')) {
                      suggestions.push('ğŸ“ í•¨ìˆ˜ë‚˜ í´ë˜ìŠ¤ê°€ ë„ˆë¬´ ê¸¸ì§€ ì•Šì€ì§€ í™•ì¸í•´ë³´ì„¸ìš”. (í•¨ìˆ˜: 20ì¤„ ì´í•˜, í´ë˜ìŠ¤: 200ì¤„ ì´í•˜ ê¶Œì¥)');
                    }
                    
                    // 5. Exception ì²˜ë¦¬ ì²´í¬
                    if (code.includes('except:') && !code.includes('except ')) {
                      suggestions.push('âš ï¸ êµ¬ì²´ì ì¸ ì˜ˆì™¸ íƒ€ì…ì„ ëª…ì‹œí•˜ì„¸ìš”. `except:` ëŒ€ì‹  `except SpecificException:`ì„ ì‚¬ìš©í•˜ì„¸ìš”.');
                    }
                    
                    // 6. Print ë¬¸ ì²´í¬ (ë¡œê¹… ê¶Œì¥)
                    if (code.includes('print(') && !filename.includes('test_')) {
                      suggestions.push('ğŸ“ `print()` ëŒ€ì‹  `logging` ëª¨ë“ˆ ì‚¬ìš©ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.');
                    }
                    
                    // 7. TODO/FIXME ì²´í¬
                    if (code.includes('TODO') || code.includes('FIXME')) {
                      suggestions.push('ğŸ“‹ TODO/FIXME í•­ëª©ì„ ì´ìŠˆë¡œ ë“±ë¡í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.');
                    }
                    
                    // 8. íƒ€ì… íŒíŠ¸ ì²´í¬
                    if (code.includes('def ') && !code.includes('->') && !code.includes('test_')) {
                      suggestions.push('ğŸ·ï¸ íƒ€ì… íŒíŠ¸ ì¶”ê°€ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”. (ì˜ˆ: `def func(param: str) -> int:`)');
                    }
                    
                    if (suggestions.length > 0) {
                      reviews.push({
                        path: filename,
                        line: lineNumber,
                        body: suggestions.join('\n\n')
                      });
                    }
                  }
                }
              }
              
              // ì„¤ì • íŒŒì¼ì— ëŒ€í•œ ë¦¬ë·°
              if (filename.includes('requirements.txt')) {
                reviews.push({
                  path: filename,
                  body: 'ğŸ“¦ ì˜ì¡´ì„± ë²„ì „ì„ ê³ ì •í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”. (ì˜ˆ: `fastapi==0.68.0` ëŒ€ì‹  `fastapi>=0.68.0,<0.70.0`)'
                });
              }
              
              // GitHub Actions ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë¦¬ë·°
              if (filename.includes('.github/workflows/')) {
                reviews.push({
                  path: filename,
                  body: 'ğŸ”§ ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ ì‹œ ë³´ì•ˆê³¼ ì„±ëŠ¥ì„ ê³ ë ¤í•´ì£¼ì„¸ìš”. ë¯¼ê°í•œ ì •ë³´ëŠ” secretsë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.'
                });
              }
            }

            // ì „ì²´ì ì¸ PR ë¦¬ë·° ëŒ“ê¸€ ìƒì„±
            let overallReview = `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼\n\n`;

            if (reviews.length === 0) {
              overallReview += `âœ… **ì½”ë“œ ë¦¬ë·° ì™„ë£Œ**: ìë™ ê²€ì‚¬ì—ì„œ íŠ¹ë³„í•œ ë¬¸ì œë¥¼ ë°œê²¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n`;
            } else {
              overallReview += `ğŸ“‹ **ì´ ${reviews.length}ê°œì˜ ì œì•ˆì‚¬í•­**ì´ ìˆìŠµë‹ˆë‹¤.\n\n`;
            }

            // íŒŒì¼ë³„ í†µê³„
            const fileStats = {
              python: files.filter(f => f.filename.endsWith('.py')).length,
              test: files.filter(f => f.filename.includes('test_')).length,
              config: files.filter(f => f.filename.includes('.yml') || f.filename.includes('.yaml') || f.filename.includes('.json')).length,
              docs: files.filter(f => f.filename.includes('.md')).length
            };

            overallReview += `### ğŸ“Š ë³€ê²½ íŒŒì¼ í†µê³„\n`;
            overallReview += `- Python íŒŒì¼: ${fileStats.python}ê°œ\n`;
            overallReview += `- í…ŒìŠ¤íŠ¸ íŒŒì¼: ${fileStats.test}ê°œ\n`;
            overallReview += `- ì„¤ì • íŒŒì¼: ${fileStats.config}ê°œ\n`;
            overallReview += `- ë¬¸ì„œ íŒŒì¼: ${fileStats.docs}ê°œ\n\n`;

            // ì²´í¬ë¦¬ìŠ¤íŠ¸
            overallReview += `### âœ… ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸\n`;
            overallReview += `- [ ] ì½”ë“œê°€ í”„ë¡œì íŠ¸ ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¥¼ ë”°ë¥´ë‚˜ìš”?\n`;
            overallReview += `- [ ] ëª¨ë“  í•¨ìˆ˜ì™€ í´ë˜ìŠ¤ì— ì ì ˆí•œ docstringì´ ìˆë‚˜ìš”?\n`;
            overallReview += `- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì¶©ë¶„íˆ ì‘ì„±ë˜ì—ˆë‚˜ìš”?\n`;
            overallReview += `- [ ] ì—ëŸ¬ ì²˜ë¦¬ê°€ ì ì ˆíˆ ë˜ì–´ ìˆë‚˜ìš”?\n`;
            overallReview += `- [ ] ë³´ì•ˆ ì·¨ì•½ì ì€ ì—†ë‚˜ìš”?\n`;
            overallReview += `- [ ] ì„±ëŠ¥ì— ì˜í–¥ì„ ì£¼ëŠ” ë³€ê²½ì‚¬í•­ì€ ì—†ë‚˜ìš”?\n\n`;

            overallReview += `---\n*ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ìˆ˜ë™ ë¦¬ë·°ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.*`;

            // PRì— ì „ì²´ ë¦¬ë·° ëŒ“ê¸€ ì¶”ê°€
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: overallReview
            });

            // ê°œë³„ ë¼ì¸ ë¦¬ë·° ì¶”ê°€ (ìµœëŒ€ 10ê°œê¹Œì§€)
            const limitedReviews = reviews.slice(0, 10);

            for (const review of limitedReviews) {
              try {
                await github.rest.pulls.createReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  body: review.body,
                  path: review.path,
                  line: review.line || 1,
                  side: 'RIGHT'
                });
              } catch (error) {
                console.log(`ë¦¬ë·° ëŒ“ê¸€ ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
              }
            }
