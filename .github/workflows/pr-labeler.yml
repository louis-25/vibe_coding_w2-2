name: PR Auto Labeler

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Auto label PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const title = context.payload.pull_request.title.toLowerCase();
            const branchName = context.payload.pull_request.head.ref.toLowerCase();

            // ê¸°ì¡´ ë¼ë²¨ ì œê±°ë¥¼ ìœ„í•œ í˜„ì¬ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            // íŒŒì¼ ë³€ê²½ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const labels = [];

            // ë¸Œëœì¹˜ëª… ê¸°ë°˜ ë¼ë²¨ë§
            if (branchName.includes('feature/')) {
              labels.push('feature');
            } else if (branchName.includes('bugfix/') || branchName.includes('fix/')) {
              labels.push('bug');
            } else if (branchName.includes('hotfix/')) {
              labels.push('hotfix');
            } else if (branchName.includes('refactor/')) {
              labels.push('refactor');
            } else if (branchName.includes('docs/')) {
              labels.push('documentation');
            }

            // PR ì œëª© ê¸°ë°˜ ë¼ë²¨ë§
            if (title.includes('feat') || title.includes('feature')) {
              labels.push('feature');
            }
            if (title.includes('fix') || title.includes('bug')) {
              labels.push('bug');
            }
            if (title.includes('doc') || title.includes('readme')) {
              labels.push('documentation');
            }
            if (title.includes('test')) {
              labels.push('testing');
            }
            if (title.includes('refactor')) {
              labels.push('refactor');
            }
            if (title.includes('style')) {
              labels.push('style');
            }
            if (title.includes('perf') || title.includes('performance')) {
              labels.push('performance');
            }

            // íŒŒì¼ ë³€ê²½ ê¸°ë°˜ ë¼ë²¨ë§
            const backendFiles = files.filter(file => 
              file.filename.startsWith('backend/') || 
              file.filename.includes('api') ||
              file.filename.includes('main.py')
            );

            const frontendFiles = files.filter(file => 
              file.filename.startsWith('frontend/') ||
              file.filename.includes('streamlit') ||
              file.filename.includes('app.py')
            );

            const testFiles = files.filter(file => 
              file.filename.startsWith('tests/') ||
              file.filename.includes('test_')
            );

            const docFiles = files.filter(file => 
              file.filename.includes('.md') ||
              file.filename.includes('docs/') ||
              file.filename.includes('README')
            );

            const configFiles = files.filter(file => 
              file.filename.startsWith('.github/') ||
              file.filename.includes('requirements') ||
              file.filename.includes('.yml') ||
              file.filename.includes('.yaml') ||
              file.filename.includes('.json') ||
              file.filename.includes('.toml')
            );

            if (backendFiles.length > 0) {
              labels.push('backend');
            }

            if (frontendFiles.length > 0) {
              labels.push('frontend');
            }

            if (testFiles.length > 0) {
              labels.push('testing');
            }

            if (docFiles.length > 0) {
              labels.push('documentation');
            }

            if (configFiles.length > 0) {
              labels.push('configuration');
            }

            // ë³€ê²½ í¬ê¸°ì— ë”°ë¥¸ ë¼ë²¨ë§
            const totalChanges = files.reduce((sum, file) => sum + file.changes, 0);

            if (totalChanges < 10) {
              labels.push('size/XS');
            } else if (totalChanges < 30) {
              labels.push('size/S');
            } else if (totalChanges < 100) {
              labels.push('size/M');
            } else if (totalChanges < 500) {
              labels.push('size/L');
            } else {
              labels.push('size/XL');
            }

            // ìš°ì„ ìˆœìœ„ ë¼ë²¨ë§ (ì œëª© ê¸°ë°˜)
            if (title.includes('urgent') || title.includes('critical') || title.includes('hotfix')) {
              labels.push('priority: high');
            } else if (title.includes('important')) {
              labels.push('priority: medium');
            } else {
              labels.push('priority: low');
            }

            // ì¤‘ë³µ ì œê±°
            const uniqueLabels = [...new Set(labels)];

            // ë¼ë²¨ ì ìš©
            if (uniqueLabels.length > 0) {
              await github.rest.issues.setLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: uniqueLabels
              });
              
              // ë¼ë²¨ë§ ì™„ë£Œ ëŒ“ê¸€
              const comment = `### ğŸ·ï¸ ìë™ ë¼ë²¨ë§ ì™„ë£Œ
              
              ë‹¤ìŒ ë¼ë²¨ì´ ìë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤:
              ${uniqueLabels.map(label => `\`${label}\``).join(', ')}
              
              **ë¶„ì„ ê²°ê³¼**:
              - ì´ ë³€ê²½ ë¼ì¸ ìˆ˜: ${totalChanges}ì¤„
              - ë°±ì—”ë“œ íŒŒì¼: ${backendFiles.length}ê°œ
              - í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼: ${frontendFiles.length}ê°œ
              - í…ŒìŠ¤íŠ¸ íŒŒì¼: ${testFiles.length}ê°œ
              - ë¬¸ì„œ íŒŒì¼: ${docFiles.length}ê°œ
              - ì„¤ì • íŒŒì¼: ${configFiles.length}ê°œ
              
              ---
              *ë¼ë²¨ì´ ìë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.*`;
              
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
